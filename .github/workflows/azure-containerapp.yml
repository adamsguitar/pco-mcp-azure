name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

env:
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_CONTAINERAPPS_ENVIRONMENT: ${{ vars.AZURE_CONTAINERAPPS_ENVIRONMENT }}
  AZURE_CONTAINER_APP_NAME: ${{ vars.AZURE_CONTAINER_APP_NAME }}
  AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}
  TF_STATE_RESOURCE_GROUP: ${{ vars.TF_STATE_RESOURCE_GROUP }}
  TF_STATE_STORAGE_ACCOUNT: ${{ vars.TF_STATE_STORAGE_ACCOUNT }}
  TF_STATE_CONTAINER: ${{ vars.TF_STATE_CONTAINER }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve image settings
        shell: bash
        run: |
          set -euo pipefail
          config_file="deployment-config.env"
          image_name=$(awk -F'=' '/^container_image_name/ {gsub(/["[:space:]]/, "", $2); print $2}' "$config_file")
          image_tag=$(awk -F'=' '/^container_image_tag/ {gsub(/["[:space:]]/, "", $2); print $2}' "$config_file")
          if [[ -z "${image_name}" ]]; then
            echo "container_image_name not found in $config_file" >&2
            exit 1
          fi
          if [[ -z "${image_tag}" ]]; then
            image_tag="latest"
          fi
          echo "IMAGE_NAME=${image_name}" >> "$GITHUB_ENV"
          echo "IMAGE_TAG=${image_tag}" >> "$GITHUB_ENV"

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Export ARM credentials for Terraform
        shell: bash
        run: |
          set -euo pipefail
          echo "ARM_CLIENT_ID=$(jq -r .clientId <<< '${{ secrets.AZURE_CREDENTIALS }}')" >> "$GITHUB_ENV"
          echo "ARM_CLIENT_SECRET=$(jq -r .clientSecret <<< '${{ secrets.AZURE_CREDENTIALS }}')" >> "$GITHUB_ENV"
          echo "ARM_TENANT_ID=$(jq -r .tenantId <<< '${{ secrets.AZURE_CREDENTIALS }}')" >> "$GITHUB_ENV"
          echo "ARM_SUBSCRIPTION_ID=$(jq -r .subscriptionId <<< '${{ secrets.AZURE_CREDENTIALS }}')" >> "$GITHUB_ENV"
          echo "AZURE_SUBSCRIPTION_ID=$(jq -r .subscriptionId <<< '${{ secrets.AZURE_CREDENTIALS }}')" >> "$GITHUB_ENV"

      - name: Bootstrap Terraform backend
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -euo pipefail
            ./scripts/bootstrap-tf-backend.sh

      - name: Terraform Init
        working-directory: infra
        run: |
          terraform init \
            -backend-config="resource_group_name=${TF_STATE_RESOURCE_GROUP}" \
            -backend-config="storage_account_name=${TF_STATE_STORAGE_ACCOUNT}" \
            -backend-config="container_name=${TF_STATE_CONTAINER}" \
            -backend-config="key=terraform.tfstate"

      - name: Login to ACR for Docker
        shell: bash
        run: |
          set -euo pipefail
          ACR_LOGIN_SERVER="${AZURE_ACR_NAME}.azurecr.io"
          token=$(az acr login --name "$AZURE_ACR_NAME" --expose-token --output tsv --query accessToken)
          echo "$token" | docker login "$ACR_LOGIN_SERVER" --username 00000000-0000-0000-0000-000000000000 --password-stdin

      - name: Build and push image to ACR
        shell: bash
        run: |
          set -euo pipefail
          image_ref="${AZURE_ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}"
          docker build -t "$image_ref" .
          docker push "$image_ref"

      - name: Terraform Plan
        working-directory: infra
        env:
          TF_VAR_location: ${{ env.AZURE_LOCATION }}
          TF_VAR_resource_group_name: ${{ env.AZURE_RESOURCE_GROUP }}
          TF_VAR_acr_name: ${{ env.AZURE_ACR_NAME }}
          TF_VAR_containerapps_environment_name: ${{ env.AZURE_CONTAINERAPPS_ENVIRONMENT }}
          TF_VAR_container_app_name: ${{ env.AZURE_CONTAINER_APP_NAME }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: infra
        env:
          TF_VAR_location: ${{ env.AZURE_LOCATION }}
          TF_VAR_resource_group_name: ${{ env.AZURE_RESOURCE_GROUP }}
          TF_VAR_acr_name: ${{ env.AZURE_ACR_NAME }}
          TF_VAR_containerapps_environment_name: ${{ env.AZURE_CONTAINERAPPS_ENVIRONMENT }}
          TF_VAR_container_app_name: ${{ env.AZURE_CONTAINER_APP_NAME }}
        run: terraform apply -auto-approve tfplan

      - name: Get User-Assigned Identity
        shell: bash
        run: |
          set -euo pipefail
          IDENTITY_RESOURCE_ID=$(az identity show \
            --name "${AZURE_CONTAINER_APP_NAME}-acr-pull" \
            --resource-group "$AZURE_RESOURCE_GROUP" \
            --query id -o tsv)
          echo "IDENTITY_RESOURCE_ID=${IDENTITY_RESOURCE_ID}" >> "$GITHUB_ENV"

      - name: Create or update Container App with secrets
        shell: bash
        run: |
          set -euo pipefail

          IMAGE_REF="${AZURE_ACR_NAME}.azurecr.io/${IMAGE_NAME}:${IMAGE_TAG}"

          # Check if Container App exists and get its provisioning state
          PROVISIONING_STATE=""
          if az containerapp show --name "$AZURE_CONTAINER_APP_NAME" --resource-group "$AZURE_RESOURCE_GROUP" &>/dev/null; then
            PROVISIONING_STATE=$(az containerapp show \
              --name "$AZURE_CONTAINER_APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --query "properties.provisioningState" -o tsv 2>/dev/null || echo "Unknown")
            echo "Container App exists with provisioning state: $PROVISIONING_STATE"
          fi

          # If Container App is in Failed state, delete it first
          if [[ "$PROVISIONING_STATE" == "Failed" ]]; then
            echo "Container App is in Failed state - deleting and will recreate..."
            az containerapp delete \
              --name "$AZURE_CONTAINER_APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --yes
            PROVISIONING_STATE=""
            echo "Deleted failed Container App"
          fi

          # Create or update based on existence
          if [[ -n "$PROVISIONING_STATE" && "$PROVISIONING_STATE" == "Succeeded" ]]; then
            echo "Container App exists and is healthy - updating..."

            # Step 1: Update secrets first (before they're referenced)
            echo "Updating secrets..."
            az containerapp secret set \
              --name "$AZURE_CONTAINER_APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --secrets \
                "pco-application-id=${{ secrets.PCO_APPLICATION_ID }}" \
                "pco-secret-key=${{ secrets.PCO_SECRET_KEY }}"

            # Step 2: Update the container app with new image and env vars
            echo "Updating Container App..."
            az containerapp update \
              --name "$AZURE_CONTAINER_APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --image "$IMAGE_REF" \
              --set-env-vars \
                "PCO_APPLICATION_ID=secretref:pco-application-id" \
                "PCO_SECRET_KEY=secretref:pco-secret-key" \
              --cpu 0.5 \
              --memory 1Gi
          else
            echo "Container App does not exist - creating..."
            az containerapp create \
              --name "$AZURE_CONTAINER_APP_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --environment "$AZURE_CONTAINERAPPS_ENVIRONMENT" \
              --image "$IMAGE_REF" \
              --target-port 8080 \
              --ingress external \
              --registry-server "${AZURE_ACR_NAME}.azurecr.io" \
              --registry-identity "$IDENTITY_RESOURCE_ID" \
              --user-assigned "$IDENTITY_RESOURCE_ID" \
              --secrets \
                "pco-application-id=${{ secrets.PCO_APPLICATION_ID }}" \
                "pco-secret-key=${{ secrets.PCO_SECRET_KEY }}" \
              --env-vars \
                "PCO_APPLICATION_ID=secretref:pco-application-id" \
                "PCO_SECRET_KEY=secretref:pco-secret-key" \
              --cpu 0.5 \
              --memory 1Gi \
              --min-replicas 0 \
              --max-replicas 10
          fi

          echo "Container App deployment complete"
