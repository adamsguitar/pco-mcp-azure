name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

env:
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  AZURE_CONTAINERAPPS_ENVIRONMENT: ${{ vars.AZURE_CONTAINERAPPS_ENVIRONMENT }}
  AZURE_CONTAINER_APP_NAME: ${{ vars.AZURE_CONTAINER_APP_NAME }}
  AZURE_ACR_NAME: ${{ vars.AZURE_ACR_NAME }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure resources exist
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -euo pipefail

            az group create \
              --name "$AZURE_RESOURCE_GROUP" \
              --location "$AZURE_LOCATION" \
              --output none

            az acr create \
              --name "$AZURE_ACR_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --location "$AZURE_LOCATION" \
              --sku Basic \
              --admin-enabled false \
              --output none

            az containerapp env create \
              --name "$AZURE_CONTAINERAPPS_ENVIRONMENT" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --location "$AZURE_LOCATION" \
              --output none

      - name: Build and deploy Container App
        uses: azure/container-apps-deploy-action@v2
        with:
          appSourcePath: ${{ github.workspace }}
          acrName: ${{ env.AZURE_ACR_NAME }}
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          resourceGroup: ${{ env.AZURE_RESOURCE_GROUP }}
          containerAppEnvironment: ${{ env.AZURE_CONTAINERAPPS_ENVIRONMENT }}
          imageToBuild: ${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.AZURE_CONTAINER_APP_NAME }}:${{ github.sha }}
          ingress: external
          targetPort: 8080
          envVars: |
            PCO_APPLICATION_ID=${{ secrets.PCO_APPLICATION_ID }}
            PCO_SECRET_KEY=${{ secrets.PCO_SECRET_KEY }}
